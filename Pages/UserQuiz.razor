@page "/quizes/userquiz/{quizId:int}"
@attribute [Authorize]
@using BlzrQuiz.ServiceLayer
@using BlzrQuiz.Data.EfClasses
@using System.Text
@using Microsoft.AspNetCore.Identity
@inject QuizService QService
@inject NavigationManager urihelper
@inject UserManager<IdentityUser> _UserManager
@inject AuthenticationStateProvider _Auth

<div class="container">
    @if (QuestionList.Count() == 0)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="row">
            <div class="col-3">
                <h3>Question: @UQuestion.QuestionNumber  : @UserName</h3>
            </div>
            <div class="col-6"></div>
            <div style="vertical-align:top; margin-bottom: 10px;" class="col-3 align-content-right">
                <div class="btn-group align-top" role="group" aria-label="Basic example">
                    <button id="btn-previous" @onclick="PreviousQuestion" type="button" class="@BtnPreviousClasses">Previous</button>
                    <button id="btn-next" @onclick="NextQuestion" style="margin-left: 10px;" type="button" class="@BtnNextClasses">Next</button>
                </div>
            </div>
        </div>
        <div class="row col-12">
            @*Referencing Child Blazor Components: <ChildComponentName ChildComponent-Property="ThisComponent-Property></ChildComponentName>"*@
            <UserQuizQuestion ThisQuestion="UQuestion" ThisUserQuiz="ThisUserQuiz"></UserQuizQuestion>
        </div>

    }
</div>

@code {
    [Parameter] public int QuizId { get; set; }
    [Parameter] public int CertId { get; set; }
    private static readonly string Enabled = "btn btn-secondary";
    private static readonly string Disabled = "btn btn-secondary disabled";
    private string BtnPreviousClasses { get; set; } = Disabled;
    private string BtnNextClasses { get; set; } = Enabled;

    IEnumerable<QuizQuestion> QuestionList { get; set; } = new List<QuizQuestion>();
    int QLCount = 0;
    int counter = 0;
    public QuizQuestion UQuestion { get; set; } = new QuizQuestion();
    //public QuizQuestion ThisQuestion { get; set; }
    private BlzrQuiz.Data.EfClasses.UserQuiz ThisUserQuiz { get; set; }
    public string UserName { get; set; } = "No One";
    protected override async Task OnInitializedAsync()
    {
        CertId = 3;
        try
        {
            await GetUserQuiz();
            QuestionList = ThisUserQuiz.Quiz.QuizQuestions;
            QLCount = QuestionList.Count() - 1;
            counter = 0;
            UQuestion = QuestionList.ElementAt(0);
            counter = 0;
            SetProperties();
            SetButtons();
        }
        catch (InvalidOperationException)
        {
            Console.WriteLine($"<**********> BAAAAAD");
        }
        Console.WriteLine($"<**********> QuestionList size: {QLCount}");

    }

    protected async Task GetUserQuiz()
    {
        var authState = await _Auth.GetAuthenticationStateAsync();
        var user = authState.User;
        UserName = user.Identity.Name ?? "Nada";
        ThisUserQuiz = await QService.GetUserQuizQuestions(QuizId, user.Identity.Name);
        if (ThisUserQuiz is null)
        {
            if (user.Identity.IsAuthenticated)
            {
                ThisUserQuiz = await QService.CreateUserQuiz(CertId, user.Identity.Name);
            }
            else
            {
                ThisUserQuiz = await QService.CreateUserQuiz(CertId, "Nada");
            }
        }
    }
    void NextQuestion()
    {
        Console.WriteLine("Tring to move to next question");
        if (QLCount > counter++)
        {
            UpdateDB();
        }
        else
        {
            Console.WriteLine($"QLCount({QLCount}) is less than the counter({counter - 1})");
            --counter;
        }
        SetProperties();
        SetButtons();
        Console.WriteLine($"End of NextQuestion. Counter {counter}. Answers: {WriteAnswers()}");

    }
    void UpdateDB()
    {
        if (UQuestion.UserQuizQuestionAnswers is null)
            UQuestion.UserQuizQuestionAnswers = new List<UserQuizQuestionAnswer>();

        Console.WriteLine($"QLCount({QLCount}) is more than the counter({counter - 1})");

        Console.WriteLine($"QuestionId: {UQuestion.QuestionId}. ThisUserQuizId: {ThisUserQuiz.UserQuizId}");
        QService.AddOrUpdateAnswersForUserQuiz(UQuestion, ThisUserQuiz.UserQuizId);
    }
    void PreviousQuestion()
    {
        Console.WriteLine($"In PreviousQuestion counter({counter})");
        if (counter-- > 0)
        {
            UpdateDB();
        }
        else
        {
            ++counter;
        }
        SetButtons();
        Console.WriteLine($"End of PrevQuestion. Counter {counter}. Answers: {WriteAnswers()}");
    }
    private string WriteAnswers()
    {
        var sb = new StringBuilder();
        foreach (var a in UQuestion.UserQuizQuestionAnswers) { sb.Append('-').Append(a); }
        return sb.ToString();
    }
    void SetButtons()
    {
        if (counter > 0 && counter < QLCount)
        {
            if (counter == 1)
            {
                BtnPreviousClasses = Enabled;
            }
            else if (counter == QLCount - 1)
            {
                BtnNextClasses = Enabled;
            }
        }
        else
        {
            if (counter == QLCount)
            {
                BtnNextClasses = Disabled;
                BtnPreviousClasses = Enabled;
            }
            else if (counter == 0)
            {
                BtnPreviousClasses = Disabled;
                BtnNextClasses = Enabled;
            }
        }

    }
    void SetProperties()
    {
        Console.WriteLine("Passed QLCount check");
        UQuestion = QuestionList.ElementAt(counter);
    }
}
